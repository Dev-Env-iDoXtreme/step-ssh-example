# step-ssh-example
This repo contains a showcase of how to use ssh certificates (for hosts & users) generated by [`step-ca`](https://github.com/smallstep/certificates) using the `step` CLI's `ssh` sub-command. It will show:

* How to provision [`step-ca`](https://github.com/smallstep/certificates) to issue SSH host & user certificates.
* How to configure `sshd` to accept user certs for client authentication using a CA key.
* How to configure `sshd` to present a host cert for host authentication on the client side.
* How to configure a user's `ssh` to accept host certs sigend by a CA key.

If you haven't already you should [read our blog](https://smallstep.com/blog) why ssh certificates let you achieve de facto SSH Single Sign-on while doing away with pesky public key management across your server fleet.

The code in this repo comes with a pre-generated PKI. You will need `step` v0.12.0+ installed. It will use the popular tool [Vagrant](https://www.vagrantup.com/docs/installation/) to provision a ssh certificate enabled VM.

## Setup VM

With Vagrant installed run following commands inside the repo:

```
$ vagrant up
Bringing machine 'testhost' up with 'virtualbox' provider...
==> testhost: Importing base box 'ubuntu/bionic64'...
    [...]
==> testhost: Preparing network interfaces based on configuration...
    testhost: Adapter 1: nat
    testhost: Adapter 2: hostonly
==> testhost: Forwarding ports...
    testhost: 22 (guest) => 2222 (host) (adapter 1)
==> testhost: Running 'pre-boot' VM customizations...
==> testhost: Booting VM...
==> testhost: Waiting for machine to boot. This may take a few minutes...
    testhost: SSH address: 127.0.0.1:2222
    testhost: SSH username: vagrant
    testhost: SSH auth method: private key
    testhost: VirtualBox Version: 6.0
    [...]
==> testhost: Setting hostname...
==> testhost: Configuring and enabling network interfaces...
==> testhost: Mounting shared folders...
    testhost: /keys => /Users/sourishkrout/dev/src/smallstep/code/src/github.com/smallstep/step-examples/ssh-example/keys
    testhost: /vagrant => /Users/sourishkrout/dev/src/smallstep/code/src/github.com/smallstep/step-examples/ssh-example
==> testhost: Running provisioner: shell...
    testhost: Running: inline script
    testhost: Add following line to your local hosts ~/.ssh/known_hosts file to accept host certs
    testhost: @cert-authority * ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBJJM+jkIdieQvdPb8DwnfnJudEc9PgVBqLDWHKgvqoIiMXhuIyGstQ9ULOBMdJkqxMjkRTFZp1iFvIk+iU6hwTA=
    testhost: Add a /etc/hosts file entry `testhost` to resolve to 192.168.0.101
    testhost: Check out README.md to learn how to grab user ssh certs to log into testhost
```

### Configure ssh client to accept host certs

Go ahead and follow the instructions printed by Vagrant. This will allow your local ssh client to accept SSH host certificates signed by the private key that matches the public key specified here. Following command will append the ssh host CA to your local `known_hosts` file:

```
$ echo "@cert-authority * ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBJJM+jkIdieQvdPb8DwnfnJudEc9PgVBqLDWHKgvqoIiMXhuIyGstQ9ULOBMdJkqxMjkRTFZp1iFvIk+iU6hwTA=" >> ~/.ssh/known_hosts
```

You can also find the SSH CA key for host stored at `step/certs/ssh_host_key.pub` in this repo.

Certificates bind names to public keys. In the case of this SSH host cert it's issued for `testhost` which is why we have to add following entry to your local `/etc/hosts` file:

```
$ tail -n 1 /etc/hosts
192.168.0.101   testhost
```

### Configure sshd to accept user certs

What Vagrant has already done for you is configure `sshd` on `testhost`, the VM generated by Vagrant. Please note that for demo purposes the PKI is shared with the VM using a shared directory mount. Below you can see the relevant lines from the `testhost` VM's `sshd_config`:

```
vagrant@testhost:~$ tail -n 5 /etc/ssh/sshd_config
#       PermitTTY no
#       ForceCommand cvs server
TrustedUserCAKeys /keys/ssh_user_key.pub
HostKey /keys/ssh_host_ecdsa_key
HostCertificate /keys/ssh_host_ecdsa_key-cert.pub
```

### Login to VM via SSH user cert
To log into the `testhost` VM we will need to grab a valid user certificate via `step ssh certificate` which will fetch it from your SSH-CA-enabled instance of [`step-ca`](https://github.com/smallstep/certificates) like so...

In one terminal window run following command (password is `password`):
```
$ export STEPPATH=`pwd`/step
$ step-ca step/config/ca.json
Please enter the password to decrypt step/secrets/intermediate_ca_key: password
Please enter the password to decrypt step/secrets/ssh_host_key: password
Please enter the password to decrypt step/secrets/ssh_user_key: password
2019/09/11 22:59:01 Serving HTTPS on :443 ...
```

In another terminal window run this:
```
$ export STEPPATH=`pwd`/step
$ step ssh certificate testuser testuser_ecdsa
step ssh certificate testuser testuser_ecdsa
✔ Provisioner: admin (JWK) [kid: ux6AhkfzgclpI65xJeGHzNqHCmdCl0-nWO8YqF1mcn0]
✔ Please enter the password to decrypt the provisioner key: password
✔ CA: https://localhost
Please enter the password to encrypt the private key: your-own-password
✔ Private Key: testuser_ecdsa
✔ Public Key: testuser_ecdsa.pub
✔ Certificate: testuser_ecdsa-cert.pub
✔ SSH Agent: yes
```

Conveniently `step` CLI add your SSH user cert to your local `ssh agent`. Now you will be able login up until four hours later (default) when the cert expires.

```
$ ssh-add -l
256 SHA256:xt5VeMEG8uf+SBlddauylJHv9+Bl0E6H+46AV94+Its testuser (ECDSA-CERT)

$ ssh testuser@testhost
ssh testuser@testhost
Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-55-generic x86_64)

[...]

testuser@testhost:~$
```

Boom! As you can see the `testhost` VM will welcome you with a matching `testuser@testhost` prompt.
